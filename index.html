<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIDS Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;700&display=swap');
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --border-color: #30363d;
            --text-color: #c9d1d9;
            --glow-color: #58a6ff;
            --danger-color: #f85149;
            --warning-color: #eac54f;
            --success-color: #238636;
        }
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        header h1 {
            color: var(--glow-color);
            text-shadow: 0 0 8px rgba(88, 166, 255, 0.5);
            margin: 0;
            font-size: 1.8em;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-light {
            width: 12px;
            height: 12px;
            background-color: var(--success-color);
            border-radius: 50%;
            box-shadow: 0 0 12px var(--success-color);
            animation: pulse 2s infinite;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-items: start;
            gap: 20px;
        }
        .panel {
            background: linear-gradient(145deg, rgba(22, 27, 34, 0.8), rgba(13, 17, 23, 0.8));
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        .panel-title {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #traffic-panel {
            height: 300px;
        }
        #alerts-panel {
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        #alerts-log {
            flex-grow: 1;
            overflow-y: auto;
        }
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
        }
        .alert-ddos { background-color: rgba(248, 81, 73, 0.1); border-left: 3px solid var(--danger-color); }
        .alert-pattern { background-color: rgba(234, 197, 79, 0.1); border-left: 3px solid var(--warning-color); }
        .alert .ip { font-weight: bold; color: var(--glow-color); }
        .alert .type-ddos { color: var(--danger-color); }
        .alert .type-pattern { color: var(--warning-color); }
        .alert .timestamp { font-size: 0.8em; color: #8b949e; }
        .stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--glow-color);
            line-height: 1.2;
        }
        .stat-label { font-size: 0.9em; text-transform: uppercase; }
        #sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #attackers-panel ul { list-style: none; padding: 0; margin: 0; }
        #attackers-panel li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border-color); }
        #attackers-panel li:last-child { border-bottom: none; }
        .ddos-controls { display: flex; gap: 10px; margin-top: 20px; }
        .ddos-controls button {
            flex-grow: 1; padding: 10px; border: 1px solid var(--border-color);
            background-color: var(--panel-bg); color: var(--text-color);
            border-radius: 5px; cursor: pointer; transition: all 0.2s ease;
        }
        .ddos-controls button.start:hover { background-color: var(--danger-color); border-color: var(--danger-color); }
        .ddos-controls button.stop:hover { background-color: var(--success-color); border-color: var(--success-color); }
        
        @keyframes pulse { 0% { box-shadow: 0 0 8px var(--success-color); } 50% { box-shadow: 0 0 16px var(--success-color); } 100% { box-shadow: 0 0 8px var(--success-color); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive Layout */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>NIDS Live Threat Dashboard</h1>
            <div class="status">
                <div class="status-light"></div>
                <span>SYSTEM ONLINE</span>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Main content column -->
            <div id="main-content">
                <div class="panel stat-card">
                    <div class="stat-value" id="total-packets">0</div>
                    <div class="stat-label">Total Packets Processed</div>
                </div>
                <div class="panel stat-card">
                    <div class="stat-value" id="patterns-detected">0</div>
                    <div class="stat-label">Pattern Detections</div>
                </div>
                <div class="panel stat-card">
                    <div class="stat-value" id="ddos-alerts">0</div>
                    <div class="stat-label">DDoS Alerts</div>
                </div>
                 <div class="panel" id="traffic-panel">
                    <h2 class="panel-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                        Live Traffic (Packets/sec)
                    </h2>
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>

            <!-- Sidebar column -->
            <div id="sidebar">
                <div class="panel" id="attackers-panel">
                    <h2 class="panel-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="21.17" y1="8" x2="12" y2="8"></line><line x1="3.95" y1="6.06" x2="8.54" y2="14"></line><line x1="10.88" y1="21.94" x2="15.46" y2="14"></line></svg>
                        Top Attacking IPs
                    </h2>
                    <ul id="top-attackers-list"></ul>
                    <div class="ddos-controls">
                        <button class="start" onclick="fetch('/api/ddos/start')">▶ Start DDoS Sim</button>
                        <button class="stop" onclick="fetch('/api/ddos/stop')">■ Stop DDoS Sim</button>
                    </div>
                </div>
                <div class="panel" id="alerts-panel">
                    <h2 class="panel-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        Live Alerts
                    </h2>
                    <div id="alerts-log"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const alertsLog = document.getElementById('alerts-log');
        const totalPacketsEl = document.getElementById('total-packets');
        const patternsDetectedEl = document.getElementById('patterns-detected');
        const ddosAlertsEl = document.getElementById('ddos-alerts');
        const topAttackersList = document.getElementById('top-attackers-list');
        let lastAlertsCount = 0;

        // --- Chart.js Setup ---
        const ctx = document.getElementById('trafficChart').getContext('2d');
        const trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Packets/sec',
                    data: [],
                    borderColor: 'rgba(88, 166, 255, 0.8)',
                    backgroundColor: 'rgba(88, 166, 255, 0.2)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, ticks: { color: '#8b949e' }, grid: { color: 'rgba(139, 148, 158, 0.2)' } },
                    x: { ticks: { color: '#8b949e' }, grid: { color: 'rgba(139, 148, 158, 0.2)' } }
                },
                plugins: { legend: { display: false } },
                maintainAspectRatio: false
            }
        });

        async function updateDashboard() {
            try {
                const [statsRes, alertsRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/alerts')
                ]);
                const stats = await statsRes.json();
                const alertsData = await alertsRes.json();

                // Update Stat Cards
                totalPacketsEl.textContent = (stats.total_packets || 0).toLocaleString();
                patternsDetectedEl.textContent = (stats.patterns_detected || 0).toLocaleString();
                ddosAlertsEl.textContent = (stats.ddos_alerts || 0).toLocaleString();

                // Update Top Attackers
                const attackers = Object.entries(stats.top_attackers || {}).sort((a, b) => b[1] - a[1]).slice(0, 5);
                topAttackersList.innerHTML = attackers.map(([ip, count]) => `<li><span>${ip}</span><span>${count} hits</span></li>`).join('');

                // Update Alerts Log
                if (alertsData.alerts.length > lastAlertsCount) {
                    const newAlerts = alertsData.alerts.slice(lastAlertsCount);
                    newAlerts.forEach(alert => {
                        const alertDiv = document.createElement('div');
                        const alertTypeClass = alert.type === 'DDoS Attempt' ? 'alert-ddos' : 'alert-pattern';
                        const alertTypeSpan = alert.type === 'DDoS Attempt' ? 'type-ddos' : 'type-pattern';
                        const timestamp = new Date(alert.timestamp * 1000).toLocaleTimeString();
                        
                        alertDiv.className = `alert ${alertTypeClass}`;
                        alertDiv.innerHTML = `
                            <div>
                                [<span class="${alertTypeSpan}">${alert.type}</span>] from <span class="ip">${alert.ip}</span>: ${alert.details}
                            </div>
                            <span class="timestamp">${timestamp}</span>
                        `;
                        alertsLog.prepend(alertDiv);
                    });
                    lastAlertsCount = alertsData.alerts.length;
                }
                
                // Update Traffic Chart
                const history = stats.traffic_history || [];
                trafficChart.data.datasets[0].data = history;
                trafficChart.data.labels = history.map((_, i) => `${30 - history.length + i + 1}s ago`);
                trafficChart.update();

            } catch (error) {
                console.error("Failed to fetch data:", error);
            }
        }

        setInterval(updateDashboard, 1000);
    </script>
</body>
</html>